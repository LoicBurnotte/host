#!/usr/bin/env node
/**
 * Generates host-remote.d.ts and the host-remote-types package so remote apps
 * (projectA, etc.) in other repos can install the types via npm or git.
 *
 * Run from host: npm run generate:remote-types
 * Output: host/host-remote.d.ts, host/dist-types/, and packages/host-remote-types/
 *
 * Remotes in another repo: npm install host-remote-types (from npm or git) and
 * add /// <reference types="host-remote-types" /> in their vite-env.d.ts.
 */

import { readFileSync, writeFileSync, mkdirSync, existsSync, cpSync } from 'fs'
import { join, dirname } from 'path'
import { fileURLToPath } from 'url'
import { execSync } from 'child_process'

const __dirname = dirname(fileURLToPath(import.meta.url))
const hostRoot = join(__dirname, '..')
const pkgDir = join(hostRoot, 'packages', 'host-remote-types')

const exposesPath = join(hostRoot, 'federation-exposes.json')
const exposes = JSON.parse(readFileSync(exposesPath, 'utf8'))

// 1. Emit .d.ts for src
const tsconfigTypesPath = join(hostRoot, 'tsconfig.types.json')
if (!existsSync(tsconfigTypesPath)) {
  console.error('tsconfig.types.json not found')
  process.exit(1)
}
console.log('Emitting declaration files...')
execSync(`npx tsc -p "${tsconfigTypesPath}"`, { cwd: hostRoot, stdio: 'inherit' })

// 2. Map expose key to emitted path
function srcPathToEmittedPath(srcPath) {
  return srcPath.replace(/^\.\/src\//, 'dist-types/').replace(/\.(tsx?|jsx?)$/, '')
}

const lines = [
  '// Auto-generated by scripts/generate-remote-types.mjs â€” do not edit.',
  '// Remotes: install the host-remote-types package (npm or git) and add /// <reference types="host-remote-types" />',
  '',
]

for (const [exposeKey, srcPath] of Object.entries(exposes)) {
  const moduleName = 'host' + exposeKey.replace(/^\./, '')
  const emittedPath = srcPathToEmittedPath(srcPath)
  lines.push(`declare module '${moduleName}' {`)
  lines.push(`  export * from './${emittedPath}'`)
  lines.push('}')
  lines.push('')
}

const content = lines.join('\n')

// 3. Write host-remote.d.ts at host root (for local use)
writeFileSync(join(hostRoot, 'host-remote.d.ts'), content, 'utf8')
console.log('Wrote host/host-remote.d.ts')

// 4. Publishable package for remote repos
mkdirSync(pkgDir, { recursive: true })
writeFileSync(join(pkgDir, 'host-remote.d.ts'), content, 'utf8')
cpSync(join(hostRoot, 'dist-types'), join(pkgDir, 'dist-types'), { recursive: true })
console.log('Wrote packages/host-remote-types/ (host-remote.d.ts + dist-types)')
